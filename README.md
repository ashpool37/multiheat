# Multiheat 1.0.0 — техническая документация пользователя

## 1. Назначение и область применения

**Multiheat** — учебно‑инженерная программа для постановки и решения задачи синтеза теплообменной сети (Heat Exchanger Network, HEN) для набора потоков, отдающих и получающих тепло.

Программа предназначена для:
- задания системы потоков (температуры, тепловые нагрузки и/или теплоёмкостные расходы);
- построения решения в виде набора теплообменных аппаратов и утилит (нагреватели/холодильники);
- проверки корректности готового решения;
- экспорта/импорта данных в табличных форматах;
- визуального контроля результатов в браузере.

Проект включает:
- **консольную часть (CLI)** на Zig;
- **веб‑интерфейс (Web UI)** на JavaScript, который может запускать решатель как через Zig/WASM, так и через чистый JavaScript.

### 1.1 Версионирование и совместимость конфигураций

Версии определяются на уровне сборки как единый источник правды:
- `multiheat_version = 1.0.0` — версия текущей сборки.
- `earliest_config_version = 0.0.1` — минимальная поддерживаемая версия конфигурации.

Правила проверки `multiheat.version` при чтении конфигурации:
1) Версия конфигурации должна быть **такой же или новее**, чем `earliest_config_version`.
2) **Мажорная и минорная** версия конфигурации не должны быть **новее** мажорной и минорной версии текущей сборки `multiheat_version`.
3) Формат версии должен быть строго семантическим: `MAJOR.MINOR.PATCH`.

---

## 2. Термины и модель данных

### 2.1 Потоки

В системе используются две группы потоков:
- **hot** — потоки, *отдающие тепло* (не обязательно имеющие более высокую температуру).
- **cold** — потоки, *получающие тепло* (не обязательно имеющие более низкую температуру).

Поток описывается в одной из форм:

1) **Изотермический поток** (например, фазовый переход):
- `in` задана,
- `out` отсутствует или `out == in`,
- `load > 0`.

2) **Неизотермический поток**:
- `in` и `out` заданы и различны,
- задавать **либо** `rate > 0` (МВт/К), **либо** `load > 0` (МВт).
- если задано `load` и известны `in/out`, то `rate` может быть восстановлен как `load / |out-in|`.

Единицы измерения:
- температуры: **K**
- тепловые нагрузки: **МВт**
- теплоёмкостный расход (потоковая теплоёмкость): **МВт/К**

### 2.2 Теплообменные аппараты (solution / exchanger)

Решение задаётся массивом `exchanger`, где каждая запись имеет вид:
- `hot` — индекс горячего потока (0‑based) или `null`,
- `cold` — индекс холодного потока (0‑based) или `null`,
- `load` — нагрузка аппарата (МВт), `load > 0`.

Типы аппаратов:
- **Ячейка теплообмена**: `hot != null` и `cold != null`.
- **Холодильник (cold utility)**: `hot != null` и `cold == null`.
- **Нагреватель (hot utility)**: `hot == null` и `cold != null`.

---

## 3. Форматы данных

### 3.1 TOML (основной формат конфигурации)

TOML‑файл содержит:
- `[multiheat]` — метаданные формата,
- `[[hot]]` — горячие потоки,
- `[[cold]]` — холодные потоки,
- `[[exchanger]]` — аппараты решения (опционально),
- `[stats]` — статистика решения (опционально; вычисляется автоматически после синтеза).

Минимальный обязательный заголовок:
- `version = "1.0.0"`
- `temp_unit = "K"`

Поля потока:
- `in` (K) — обязательно,
- `out` (K) — опционально,
- `rate` (МВт/К) — опционально,
- `load` (МВт) — опционально (для изотермы — обязательно).

Поля аппарата:
- `hot` (целое, 0‑based) — опционально,
- `cold` (целое, 0‑based) — опционально,
- `load` (МВт) — обязательно.

Поле `[stats]` предназначено для отображения и экспорта. Оно не является обязательным для вычислений.

### 3.2 CSV (потоки)

CSV‑формат потоков предназначен для работы в табличных редакторах (Excel/LibreOffice) и содержит заголовки на русском языке. Типовой набор колонок:
- `Номер потока` (H1.., C1..),
- `Т на входе, К`,
- `Т на выходе, К`,
- `q, МВт`,
- `W, МВт/К`,
- `Фазовый переход?` (индикатор изотермичности).

При импорте:
- изотермичность определяется по `W == 0` или `Твых == Твх`,
- для неизотермических потоков требуется `W > 0` или `q > 0`.

### 3.3 CSV (решение)

CSV‑формат решения содержит:
- `Номер ячейки` (E1..),
- `Горячий поток` (H1.. или пусто),
- `Холодный поток` (C1.. или пусто),
- `Нагрузка, МВт`,
- `Тип` (информационная колонка).

При импорте индексы переводятся в 0‑based:
- `H1` → `hot = 0`, `C1` → `cold = 0`.

### 3.4 Mermaid‑граф (CLI)

CLI может вывести текст диаграммы для Mermaid. Вывод предназначен для вставки в markdown/mermaid‑рендерер.

---

## 4. Консольная часть (CLI)

### 4.1 Назначение

CLI предназначен для пакетной обработки TOML‑входа: проверка, синтез, валидация решения, экспорт результата.

### 4.2 Запуск и команды

Общий синтаксис:
- запустить бинарь;
- указать ровно одну команду;
- передать путь к TOML‑файлу.

Команды:

- `--help`  
  Вывести справку по параметрам.

- `--checkinput <input_file>`  
  Проверить корректность входных данных (структура TOML и ограничения на поля).

- `--verify <input_file>`  
  Проверить корректность готового решения в `[[exchanger]]`.  
  Требование: решение должно присутствовать.

- `--solve <input_file>`  
  Выполнить синтез решения.  
  Результат вывести в STDOUT в формате TOML: исходный TOML + блок `[[exchanger]]`.

- `--graph <input_file>`  
  Вывести Mermaid‑граф системы. Если решение отсутствует, выполнить синтез перед построением графа.

Дополнительный флаг:

- `--terse`  
  При синтезе вывести только таблицу `[[exchanger]]` без исходного TOML‑входа.

---

## 5. Веб‑интерфейс (Web UI)

### 5.1 Назначение

Web UI предназначен для интерактивного ввода/импорта системы, запуска синтеза/проверки, просмотра и экспорта данных, а также визуализации сети и параметров.

### 5.2 Базовые операции (панель управления)

Верхняя панель действий:

- `Открыть`  
  Открыть файл и импортировать данные:
  - TOML
  - CSV (потоки)
  - CSV (решение)

- `Сохранить`  
  Экспортировать текущие представления:
  - TOML
  - CSV (потоки)
  - CSV (решение)

- `Сгенерировать`  
  Сгенерировать новую систему потоков по заданным параметрам в “Настройках”.  
  При наличии непустой системы запросить подтверждение перезаписи.

- `Сбросить`  
  Сбросить текущую систему к пустому состоянию (с подтверждением).

- `Синтезировать`  
  Выполнить синтез решения выбранным алгоритмом.

- `Проверить`  
  Проверить корректность решения (при наличии аппаратов).

### 5.3 Представления (левая панель)

Вкладки:
- `Описание` — структурированное текстовое описание потоков и решения, включая статистику.
- `Таблица` — таблицы потоков и аппаратов.
- `TOML` — текстовый редактор TOML.
- `CSV` — текстовые редакторы CSV потоков и решения.

Скрытие левой панели:
- выполнить повторное нажатие на активную вкладку, чтобы скрыть/показать левую панель.

### 5.4 Правая панель: визуализация и настройки

Правые переключатели образуют взаимоисключающую “систему вкладок”:
- `Визуализировать` — показать диаграмму сети на canvas.
- `Кривые` — показать эквивалентные температурные кривые (режим визуализации).
- `Настройки` — открыть панель параметров (алгоритм и генерация).

Панель “Настройки”:
- `Алгоритм` — выбрать реализацию синтеза (см. раздел 6).
- `Параметры генерации` — задать параметры генератора потоков (горячая/холодная сторона, доля изотерм, распределения температур и нагрузок).

---

## 6. Алгоритмы синтеза

Выбор алгоритма выполняется в панели “Настройки”. В системе используются машиночитаемые идентификаторы с суффиксом реализации:

- суффикс `_zig` — выполнение через Zig/WASM (в браузере) или Zig (в CLI, где применимо по умолчанию);
- суффикс `_js` — выполнение на чистом JavaScript (в браузере).

Доступные варианты:

1) `solve_greedy_zig` — **Жадный (Zig/WASM)**  
   Итеративный подбор пар потоков с ограничением минимального температурного напора, с постановкой утилит при отсутствии совместимости.

2) `solve_greedy_js` — **Жадный (JavaScript)**  
   Порт жадного алгоритма на JS. Результаты могут отличаться от Zig/WASM на пограничных случаях из‑за различий численной арифметики (double vs f32).

3) `solve_curves_zig` — **Эквивалентные кривые (Zig/WASM)**  
   Метод через эквивалентную двухпоточную модель и тепловой каскад (heat cascade) при заданном ΔTmin. Строит решение с минимизацией суммарной мощности утилит при выбранной процедуре распределения.

4) `solve_curves_js` — **Эквивалентные кривые (JavaScript)**  
   Порт алгоритма эквивалентных кривых на JS.

5) `solve_trivial_zig` — **Без теплообмена (Zig/WASM)**  
   Базовый сценарий: каждый hot охлаждать холодильником, каждый cold нагревать нагревателем (только утилиты, без межпоточного обмена).

---

## 7. Статистика решения

После синтеза формируется блок “Статистика” (в “Описание” и при экспорте TOML в `[stats]`). Типовые показатели:
- суммарные нагрузки hot/cold,
- разность нагрузок,
- количество ячеек теплообмена и утилит,
- суммарные нагрузки по ячейкам и утилитам,
- экономия внешней энергии относительно режима “Без теплообмена”,
- имя алгоритма,
- время синтеза (мс).

Примечание: время синтеза относится к участку выполнения решателя и не предназначено для измерения полного времени обновления пользовательского интерфейса.

---

## 8. Сборка и запуск (кратко)

CLI:
- выполнить сборку через Zig (см. `build.zig`),
- запустить бинарь с нужной командой и TOML‑файлом.

Web UI:
- перейти в каталог `www/`,
- установить зависимости,
- запустить dev‑сервер или production‑сборку через Vite.
